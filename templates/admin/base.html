<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}HotelServe Admin{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% block head %}{% endblock %}
</head>
<body style="background-color: #f8f9fa;" data-latest-order-id="{{ latest_order_id or 0 }}" data-notification-sound="{{ url_for('static', filename='sounds/notification.mp3') }}">
    <div class="d-flex" id="wrapper">
        <!-- Page Content -->
        <div id="page-content-wrapper" style="width: 100%;">
            {% include 'navbar.html' %}
            
            <main>
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <!-- Toast Container for Notifications -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
      <div id="newOrderToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <i class="fas fa-bell me-2 text-primary"></i>
          <strong class="me-auto">New Order Received!</strong>
          <small>Just now</small>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          <!-- Dynamic content will be injected here -->
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    {% block scripts %}
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // New Order Notification Polling
        let lastOrderId = document.body.dataset.latestOrderId || 0;
        const toastEl = document.getElementById('newOrderToast');
        if (toastEl) {
            const toast = new bootstrap.Toast(toastEl);

            function checkForNewOrders() {
                fetch(`/api/admin/new-orders?last_order_id=${lastOrderId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.new_order) {
                            lastOrderId = data.order.id;

                            const toastBody = toastEl.querySelector('.toast-body');
                            toastBody.innerHTML = `
                                New order <strong>#${data.order.order_number}</strong> from ${data.order.customer_name}
                                for <strong>â‚¹${data.order.total_amount.toFixed(2)}</strong>.
                                <div class="mt-2 pt-2 border-top">
                                    <a href="/order/${data.order.id}" class="btn btn-sm btn-primary">View Order</a>
                                    <a href="/admin/orders/print/${data.order.id}" target="_blank" class="btn btn-sm btn-outline-secondary">Print Receipt</a>
                                </div>
                            `;
                            
                            // Attempt to play a notification sound
                            try {
                                const soundUrl = document.body.dataset.notificationSound;
                                const audio = new Audio(soundUrl);
                                audio.play().catch(e => {
                                    console.log("Notification sound autoplay was blocked by the browser.");
                                });
                            } catch (e) {
                                console.error("Error playing notification sound:", e);
                            }

                            toast.show();

                            // Dispatch a custom event so other parts of the app can react
                            document.dispatchEvent(new CustomEvent('newOrderReceived', { detail: data.order }));
                        }
                    })
                    .catch(error => console.error('Error checking for new orders:', error));
            }

            // Poll every 15 seconds
            setInterval(checkForNewOrders, 15000);
        }
    });
    </script>
    {% endblock %}
</body>
</html>